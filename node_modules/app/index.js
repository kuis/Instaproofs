/*==========================================================================*\
  Main app's entry point
\*==========================================================================*/
"use strict";

var XHR = window.XMLHttpRequest;
require('app/fake-api/fake-api');
var Events = require('backbone-events-standalone');
var language = require('app/language');

module.exports = Events.mixin({
  
  XHR: XHR,
  eventModels: {}, // list of fully loaded event models 
  loadedImages: {}, // list of URLs for images that has been already loaded 

  isReady: false, // whether the initial page is ready
  language: language,
  // register callback for 'ready' or execute it right away ==================
  ready: function (callback) {
    var self = this;
    if (this.isReady) callback.apply(this);
    else this.once('ready', function () {
      callback.apply(self);
    });
  },
  
  // this is the the whole app initter
  blastoff: function () {
    // init our URL handlers and the history tracker
    // window.app = this;
    this.storage = window.localStorage || {};
    this.state = new AppState();
    this.cart = {};
    this.defaultOptions = null;
      
    this.config = new Config();
    this.photographer = new Photographer();
    this.purchaseOptions = new PurchaseOptions();
    this.purchaseAddons = new PurchaseAddons();
    
    this.router = new Router();


    // init our main view
    this.view = new MainView({
      // el: document.body,
      el: document.documentElement,
      model: this.state,
      language: language,
    });
    

    // start router and show the appropriate page
    this.router.history.start({
      pushState: false, 
      root: '/',
    });
    
    return this;
  },

  // This is how you navigate around the app.
  // this gets called by a global click handler that handles
  // all the <a> tags in the app.
  // it expects a url without protocol or host.
  // for example: "costello/settings".
  navigate: function (page) {
    var url = page.replace(/^[#\/]+/, '');
    this.router.history.navigate(url, { trigger: true });
  },
});

var AppState = require('app/state');
var Config = require('app/models/config-model');
var Photographer = require('app/models/photographer-model');
var Router = require('app/router');
var MainView = require('app/views/main-view');
var PurchaseOptions = require('app/models/cart/options-collection');
var PurchaseAddons = require('app/models/cart/addons-collection');
