/*==========================================================================*\
  Main app's entry point
\*==========================================================================*/
"use strict";

require('dom-shims'); // classList, matches, closest etc.

var XHR = window.XMLHttpRequest;
// require('app/fake-api/fake-api');
var Events = require('backbone-events-standalone');

module.exports = Events.mixin({
  
  XHR: XHR,
  eventModels: {}, // list of fully loaded event models 
  eventCarts: {}, // list of event cart models
  favorites: {}, // list of favorite photo lists per event 
  loadedImages: {}, // list of URLs for images that has been already loaded 

  isReady: false, // whether the initial page is ready
  // register callback for 'ready' or execute it right away ==================
  ready: function (callback) {
    var self = this;
    if (this.isReady) callback.apply(this);
    else this.once('ready', function () {
      callback.apply(self);
    });
  },
  
  // this is the the whole app initter
  blastoff: function () {
    var self = this;
    // init our URL handlers and the history tracker
    // window.app = this;
    this.storage = window.localStorage || {};
    this.state = new AppState();
    
    this.templates = require('app/templates');
    
    // this.cart = new Cart();
    // var cart = this.storage.cart ? JSON.parse(this.storage.cart) : {};
    // this.cart = cart;
    // var storedCart = this.storage.cart;
    // if (storedCart) {
    //   this.cart.set(JSON.parse(storedCart));
    //   console.log('stored cart', this.cart.toJSON());
    // }
    
    // var storedDefaultOptions = this.storage.defaultOptions;
    // if (storedDefaultOptions) {
    //   this.defaultOptions = JSON.parse(storedDefaultOptions);
    // }
    // else {
    //   this.defaultOptions = null;
    // }
    
    if (window.localStorage) {
      window.addEventListener("storage", function (e) {
        self.trigger('storage:'+ e.key, e.newValue, e.oldValue, e.url || e.uri);
      }, false);
    }
      
    this.config = new Config();
    this.photographer = new Photographer();
    this.purchaseOptions = new PurchaseOptions();
    this.purchaseAddons = new PurchaseAddons();
    this.pricingTemplates = new PricingTemplates();
    this.colors = new Colors();
    this.products = new Products();
    this.shipping = new ShippingOptions();
    this.config.fetch();
    
    this.keychain = new Keychain();
    
    this.router = new Router();


    // init our main view
    this.view = new MainView({
      // el: document.body,
      el: document.documentElement,
      model: this.state,
    });
    

    // start router and show the appropriate page
    this.router.history.start({
      pushState: false, 
      root: '/',
    });
    
    return this;
  },

  // This is how you navigate around the app.
  // this gets called by a global click handler that handles
  // all the <a> tags in the app.
  // it expects a url without protocol or host.
  // for example: "costello/settings".
  navigate: function (page) {
    var url = page.replace(/^[#\/]+/, '');
    this.router.history.navigate(url, { trigger: true });
  },
});

var AppState = require('app/state');
var Config = require('app/models/config-model');
var Photographer = require('app/models/photographer-model');
var Router = require('app/router');
var MainView = require('app/views/main-view');
var PurchaseOptions = require('app/models/cart/options-collection');
var PurchaseAddons = require('app/models/cart/addons-collection');
var PricingTemplates = require('app/models/cart/pricing-collection');
var Colors = require('app/models/cart/colors-collection');
var ShippingOptions = require('app/models/cart/shipping-collection');
var Products = require('app/models/product/products-collection');
var Keychain = require('app/models/keychain-model');
// var Cart = require('app/models/cart/cart');
