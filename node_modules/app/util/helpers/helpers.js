/*============================================================================*\
  A set of helper functions for models and views to encorporate
\*============================================================================*/
"use strict";

var app = require('app');

var imgUrlBlurRegExp = new RegExp("&blur=\\d", 'g');
var imgUrlDimensionsRegExp = new RegExp("w=([0-9]+)&h=([0-9]+)");

module.exports = {
  
  // ===========================================================================
  // bind all object's specified methods to the object
  bindMethods: function (obj, keys) {
    if (typeof keys !== 'object') keys = [keys];
    if (!keys.length) return;
    for (var i = 0; i < keys.length; i++) {
      if (typeof obj[keys[i]] === 'function') {
        obj[keys[i]] = obj[keys[i]].bind(obj);
      }
      else {
        console.warn('Trying to bind a non-function `'+ keys[i] +'`');
      }
    }
    return obj;
  },
  
  // ===========================================================================
  // formats with photographer's currency symbol
  formatMoney: function (cents, short) {
    if (isNaN(cents)) {
      return '';
    }

    var $, decimalPoints, sign;

    $ = app.config.photographer.currency_symbol;
    decimalPoints = short ? 0 : 2;
    cents = parseInt(cents);
    if (short && cents % 100 !== 0) {
      decimalPoints = cents % 10 === 0 ? 1 : 2;
    }
    sign = cents < 0 ? '-' : '';

    return sign + $ + (Math.abs(cents) / 100).toFixed(decimalPoints);
  },
  
  // ===========================================================================
  // Converts fractional discount into a percentage string
  // Either 10.X% or just 10% if it's round
  formatDiscount: function (discount) {
    if (isNaN(discount)) return 0;
    discount *= 100;
    var rounded = Math.round(discount);
    var singleDecimal = discount.toFixed(1);
    return (+rounded === +singleDecimal ? rounded : singleDecimal) + '%';
  },
  
  // ===========================================================================
  toBlurUrl: function (url) { // adds a blur flag to image URLs
    if (!url) return url;
    url = url.replace(imgUrlBlurRegExp, '');
    return url + '&blur=1';
  },
  
  // ===========================================================================
  toThumbUrl: function (url, newWidth) { // converts image URLs to a new width 
    if (!url) return url;
    var m = imgUrlDimensionsRegExp.exec(url);
    newWidth = newWidth || 450;
    if (m) {
      var width = m[1];
      var height = m[2];
      url = url.replace('w='+width, 'w='+ newWidth)
               .replace('h='+height, 'h='+ 
                        Math.round(newWidth * height / width));
      return url;
    }
    return url;
  },
};
