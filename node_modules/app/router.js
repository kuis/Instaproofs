/*==========================================================================*\
  App routes
\*==========================================================================*/
"use strict";

var app = require('app');
var EventModel = require('app/models/event');
var Lightbox = require('app/views/lightbox.js');

var pages = {}; // list of initialized page views
var views = {
  home: require('app/pages/home'),
  event: require('app/pages/event-page'),
  category: require('app/pages/event-category'),
  product: require('app/pages/event-product'),
};
var lightbox; // lightbox view


function parseQuery(query) {
  if (!query) return {};
  var vars = query.split('&');
  var data = {};
  var pair;
  for (var i = 0; i < vars.length; i++) {
    pair = vars[i].split('=');
    data[pair[0]] = pair[1];
  }
  return data;
}

module.exports = require('ampersand-router').extend({
  
  enterSlideshow: false, // enter the slideshow on next lightbox display 
  
  openPage: function (page, ops) {
    ops = ops || {};
    var id = ops.id ? page + ops.id : page;
    delete ops.id;
    var view = pages[id] ? pages[id].reset(ops) : new views[page](ops);
    pages[id] = view;
    
    this.trigger('page', view, id);
    this.trigger('page:'+id, view, id);
  },
  showLightbox: function (eid, cid, pid, back) {
    var event = app.eventModels[eid]
        || (pages.home && pages.home.list.collection.get(eid));
    var collection = event.categories.get(cid).photos;
    var photo = collection.get(pid);
        
    if (!lightbox) {
      this.lightbox = lightbox = new Lightbox({ el: app.view.query('#lightbox') });
    }
    
    lightbox.reset({
      collection: collection,
      photo: photo,
      backTo: back || '#events/'+eid+'/'+cid,
      slideshow: this.enterSlideshow,
    });
    lightbox.show();
    this.enterSlideshow = false;
  },
  
  initialize: function() {
    this.lightbox = {};

    // homepage ==============================================================
    this.route(/^events(?:\?(.*?))?$/, function (query) {
      if (lightbox) lightbox.hide();
      query = parseQuery(query);
      this.openPage('home', {
        sort: query.sort || 'date',
        filter: query.show || 'all',
      });
    });
    
    // event page ============================================================
    this.route(/^events\/(\d+)$/, function (eid) {
      if (lightbox) lightbox.hide();
      eid = +eid;
      var model = app.eventModels[eid]
          || (pages.home && pages.home.list.collection.get(eid))
          || new EventModel({ id: eid });
      app.eventModels[eid] = model;
      this.openPage('event', {
        id: eid,
        model: model,
      });
    });
    
    // event category page ===================================================
    this.route(/^events\/(\d+)\/(\d+)$/, function (eid, cid) {
      var lightboxDisplayed = !!this.lightbox.displayed;
      if (lightbox) lightbox.hide();
      
      eid = +eid;
      cid = +cid;
      var model = app.eventModels[eid]
          || (pages.home && pages.home.list.collection.get(eid))
          || new EventModel({ id: eid });
      app.eventModels[eid] = model;
      this.openPage('category', {
        id: eid+'_'+cid,
        cid: cid,
        model: model,
        showMore: lightboxDisplayed,
      });
    });
    
    // single photo ==========================================================
    this.route(/^events\/(\d+)\/(\d+)\/(\d+)$/, function (eid, cid, pid) {
      this.lightboxMode = true;
      this.willShowLightbox = true;
      var self = this;
      eid = +eid;
      cid = +cid;
      pid = +pid;
      var event = app.eventModels[eid]
          || (pages.home && pages.home.list.collection.get(eid))
          || new EventModel({ id: eid });
      app.eventModels[eid] = event;
      
      this.openPage('category', {
        id: eid+'_'+cid,
        cid: cid,
        model: event,
        showMore: false,
      });
      
      if (!app.isReady) {
        app.ready(function () {
          self.showLightbox(eid, cid, pid);
        });
      }
      else {
        this.showLightbox(eid, cid, pid);
      }
      
    });
    
  },
  
  routes: {
    '(*path)': function () { this.redirectTo('events?show=all&sort=date'); },
  },
});
