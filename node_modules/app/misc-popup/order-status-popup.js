/*==========================================================================*\
  A popup with order details
\*==========================================================================*/
"use strict";
var MiscPopup = require('./misc-popup');

var app = require('app');
var templates = require('app/templates');
var xhr = require('xhr');

var detailsTemplate = templates['misc-popup']['order-status-details'];

module.exports = MiscPopup.extend({
  template: templates['misc-popup']['order-status'],
  
  save: function () {
    if (this.xhr) return;
    
    var name = this.query('input.name').value;
    var id = this.query('input.id').value;
    if (!name) { this.query('input.name').focus(); return; }
    if (!id) { this.query('input.id').focus(); return; }
    
    var self = this;
    this.query('.button.save').classList.add('loading');
    
    this.xhr = xhr({
      uri: app.apiUrl +'orders/status?url='+ app.url +
           '&billing_last_name='+ encodeURIComponent(name)+
           '&confirmation_number='+ encodeURIComponent(id),
    }, function (err, resp, body) {
      body = JSON.parse(body);
      body.data.code = body.status;
      self.data = body.data;
      console.log(self.data.code, self.data);
      self.query('.order-details').innerHTML = detailsTemplate(self);
      self.animatedHeight = true;
      self.after(300, function () {
        self.animatedHeight = false;
      });
      self.updateHeight();
      self.query('.button.save').classList.remove('loading');
      self.xhr = null;
    });
  },
});
