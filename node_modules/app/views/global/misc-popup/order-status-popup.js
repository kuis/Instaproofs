/*==========================================================================*\
  A popup with order details
\*==========================================================================*/
"use strict";
var app = require('app');
var ua = require('app/utils/ua');
var Parent = require('./misc-popup');

var xhr = require('xhr');
var detailsTemplate = 
    require('app/templates').global['misc-popup']['order-status-details'];

module.exports = Parent.extend({
  template: require('app/templates').global['misc-popup']['order-status'],
  
  // initialize: function () {
  //   Parent.prototype.initialize.apply(this, arguments);
  // },
  
  // events: {
  //   click: 'onClick',
  // },
  
  // bindings: {
  // },
  
  save: function () {
    if (this.xhr) return;
    
    var name = this.query('input.name').value;
    var id = this.query('input.id').value;
    if (!name) { this.query('input.name').focus(); return; }
    if (!id) { this.query('input.id').focus(); return; }
    
    var self = this;
    this.query('.button.save').classList.add('loading');
    
    this.xhr = xhr({
      uri: 'http://www.instaproofs.com/api/rest2/orders/status'+
           '?url='+ app.url +
           '&billing_last_name='+ encodeURIComponent(name)+
           '&confirmation_number='+ encodeURIComponent(id),
    }, function (err, resp, body) {
      body = JSON.parse(body);
      body.data.code = body.status;
      self.data = body.data;
      console.log(self.data.code, self.data);
      self.query('.order-details').innerHTML = detailsTemplate(self);
      self.animatedHeight = true;
      self.after(300, function () {
        self.animatedHeight = false;
      });
      self.updateHeight();
      self.query('.button.save').classList.remove('loading');
      self.xhr = null;
    });
  },
});
