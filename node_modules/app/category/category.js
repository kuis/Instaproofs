/*==========================================================================*\
  Event's Category
\*==========================================================================*/
"use strict";

var app = require('app');
var BaseView = require('app/base/base-view');
var PhotosView = require('app/photo/thumbs');
var LoginView = require('./category-login');

module.exports = BaseView.extend({
  
  template: require('app/templates').category.category,
  
  preview: false, // whether this is a preview view on 'All Categories' page
  
  initialize: function (ops) {
    BaseView.prototype.initialize.apply(this, arguments);
    ops = ops || {};
    this.preview = !!ops.preview;
  },
  
  events: {
    'click .category-slideshow': 'onSlideshowClick',
  },
  
  bindings: {
    'model.name': {
      type: function (el, name) {
        if (!this.model.isFavModel) el.textContent = name;
      },
      hook: 'category-name',
    },
    
    'model.mtime': {
      type: function () {
        this.updateSledeshowLink();
      },
    },
    
    'model.locked': {
      type: function (el, val) {
        this.el.classList.toggle('locked', !!val);
        this.parent.locked = val;
      },
      // type: 'booleanClass',
      // name: 'locked',
    },
    
    'model.photos.length': {
      type: 'booleanClass',
      selector: '.event-category',
      yes: 'loaded',
      no: 'loading',
    },
    'model.photos': {
      type: function (el, list) {
        if (list.length) {
          el.setAttribute('href', list.parent.app_url +'/'+ list.at(0).id);
        }
      },
      selector: '.category-slideshow',
    },
  },
  
  render: function () {
    this.write(function () {
      this.renderWithTemplate(this);
      this.photos = new PhotosView({
        el: this.query('.photos'),
        collection: this.model.photos,
        parent: this,
        preview: this.preview,
      });
      this.cacheElements({
        slideshowEl: '.category-slideshow',
      });
      this.updateSledeshowLink();
      
      if (this.model.password) {
        this.loginView = this.renderSubview(new LoginView({ 
          model: this.model,
        }), '.login-container');
      }
    });
  },
  
  updateSledeshowLink: function () {
    if (this.slideshowEl && this.model.isFavModel && this.model.photos.length) {
      this.query('.category-slideshow').setAttribute('href',
          this.model.app_url +'/'+ this.model.photos.at(0).id);
    }
  },
  
  onPageShow: function () {
    if (this.photos && this.photos.collection && 
        this.photos.collection.length) {
      this.showMore();
      this.photos.loadPhotos();
    }
  },
  
  onSlideshowClick: function () {
    app.router.enterSlideshow = true;
  },
  
  showMore: function () {
    this.photos.showMore();
    return this;
  },
  
});






